<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –∫–≤–µ—Å—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg1: #0b1020;
      --bg2: #2a133f;
      --glass: rgba(255,255,255,.12);
      --glass2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: rgba(255,255,255,.95);
      --good: rgba(255,255,255,.95);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 22px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, rgba(255,255,255,.12), transparent 50%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(255, 166, 255, .15), transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x: hidden;
    }

    #snow {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: .95;
    }

    .wrap {
      position: relative;
      z-index: 1;
      padding: 18px 16px 28px;
      max-width: 560px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 10px;
    }

    .title {
      font-size: 20px;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }

    .card {
      margin-top: 16px;
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid rgba(255,255,255,.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 14px 14px;
      backdrop-filter: blur(10px);
    }

    .progress {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      padding: 10px 0 6px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      transform: translateZ(0);
    }
    .dot.done {
      background: rgba(255,255,255,.85);
    }
    .dot.current {
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 0 6px rgba(255,255,255,.12);
    }

    .taskTitle {
      font-size: 14px;
      color: var(--muted);
      margin: 8px 0 6px;
      text-align: center;
    }

    .taskText {
      font-size: 16px;
      line-height: 1.5;
      font-weight: 700;
      text-align: center;
      white-space: pre-wrap;
    }

    .inputRow {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    input {
      width: 100%;
      box-sizing: border-box;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 15px;
    }
    input::placeholder { color: rgba(255,255,255,.55); }

    button {
      width: 100%;
      border: none;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 800;
      color: rgba(20, 12, 30, 1);
      background: rgba(255,255,255,.95);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      cursor: pointer;
    }
    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .hint {
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
      white-space: pre-wrap;
    }

    .miniActions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .miniBtn {
      flex: 1;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.9);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: none;
      font-weight: 800;
    }

    .toast {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      min-height: 18px;
    }

    /* Modal */
    .modalBack {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 3;
    }
    .modalBack.show { display: flex; }
    .modal {
      width: 100%;
      max-width: 520px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.12));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 26px;
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      overflow: hidden;
      backdrop-filter: blur(12px);
      transform: translateY(6px);
      animation: pop .18s ease-out;
    }
    @keyframes pop {
      from { transform: translateY(16px); opacity: .8; }
      to { transform: translateY(6px); opacity: 1; }
    }
    .modalHeader {
      padding: 14px 16px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modalTitle {
      font-weight: 900;
      font-size: 16px;
    }
    .x {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.15);
      color: rgba(255,255,255,.9);
      cursor: pointer;
      font-weight: 900;
      box-shadow: none;
    }
    .modalBody {
      padding: 0 16px 14px;
    }
    .modalText {
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .imgWrap {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
    }
    .imgWrap img {
      width: 100%;
      height: auto;
      display: block;
    }
    .modalFooter {
      padding: 14px 16px 16px;
    }

    .final {
      text-align: center;
      padding: 14px 10px 4px;
    }
    .final h2 {
      margin: 6px 0 10px;
      font-size: 20px;
      font-weight: 900;
    }
    .final p {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 15px;
      font-weight: 700;
    }

    .small {
      font-size: 12px;
      color: rgba(255,255,255,.62);
      margin-top: 10px;
      text-align: center;
    }

    .shake {
      animation: shake .18s ease-in-out 0s 2;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <canvas id="snow"></canvas>

  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –∫–≤–µ—Å—Ç</div>
        <div class="subtitle">5 —à–∞–≥–æ–≤ ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Üí —Ñ–∏–Ω–∞–ª üéÅ</div>
      </div>
      <div class="chip" id="chip">‚è≥ –ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
    </div>

    <div class="card" id="mainCard">
      <div class="progress" id="progress"></div>

      <div class="taskTitle" id="taskTitle">‚Ä¶</div>
      <div class="taskText" id="taskText">‚Ä¶</div>

      <div class="inputRow" id="inputRow">
        <input id="answer" placeholder="–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç / –∫–æ–¥‚Ä¶" autocomplete="off" />
        <button id="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ‚úÖ</button>
      </div>

      <div class="miniActions" id="miniActions" style="display:none;">
        <button class="miniBtn" id="btnShowCard">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∫—É üíå</button>
        <button class="miniBtn" id="btnReload">–û–±–Ω–æ–≤–∏—Ç—å üîÑ</button>
      </div>

      <div class="hint" id="hint" style="display:none;"></div>
      <div class="toast" id="toast"></div>

      <div class="final" id="final" style="display:none;">
        <h2>üéÅ –§–∏–Ω–∞–ª</h2>
        <p id="finalText"></p>
      </div>

      <div class="small" id="small"></div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">üíå –û—Ç–∫—Ä—ã—Ç–∫–∞</div>
        <button class="x" id="modalClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="modalText" id="modalText"></div>
        <div class="imgWrap" id="modalImgWrap" style="display:none;">
          <img id="modalImg" alt="card" />
        </div>
      </div>
      <div class="modalFooter">
        <button id="modalOk">–î–∞–ª—å—à–µ ‚ú®</button>
      </div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const API_BASE = "https://n8n-production-9c7d.up.railway.app/webhook".replace(/\/$/, ""); // n8n base + /webhook
  const STATE_URL = API_BASE + "/quest/state";
  const SUBMIT_URL = API_BASE + "/quest/submit";

  const el = (id) => document.getElementById(id);
  const chip = el("chip");
  const progress = el("progress");
  const taskTitle = el("taskTitle");
  const taskText = el("taskText");
  const inputRow = el("inputRow");
  const answer = el("answer");
  const btn = el("btn");
  const toast = el("toast");
  const hint = el("hint");
  const finalBox = el("final");
  const finalText = el("finalText");
  const miniActions = el("miniActions");
  const btnShowCard = el("btnShowCard");
  const btnReload = el("btnReload");

  const modalBack = el("modalBack");
  const modalClose = el("modalClose");
  const modalOk = el("modalOk");
  const modalText = el("modalText");
  const modalImgWrap = el("modalImgWrap");
  const modalImg = el("modalImg");

  let initData = "";
  let lastCard = null;
  let unlockedFromSubmit = null;

  function setToast(msg) {
    toast.textContent = msg || "";
  }

  function showModal({ title, text, imgUrl }) {
    el("modalTitle").textContent = title || "üíå –û—Ç–∫—Ä—ã—Ç–∫–∞";
    modalText.textContent = text || "";
    if (imgUrl) {
      modalImgWrap.style.display = "block";
      modalImg.src = imgUrl;
    } else {
      modalImgWrap.style.display = "none";
      modalImg.src = "";
    }
    modalBack.classList.add("show");
  }

  function closeModal() {
    modalBack.classList.remove("show");
  }

  modalClose.onclick = closeModal;
  modalBack.addEventListener("click", (e) => {
    if (e.target === modalBack) closeModal();
  });
  modalOk.onclick = () => {
    closeModal();
    if (unlockedFromSubmit && unlockedFromSubmit.hintAfter) {
      hint.style.display = "block";
      hint.textContent = "‚ú® –ü–æ–¥—Å–∫–∞–∑–∫–∞: \n" + unlockedFromSubmit.hintAfter;
    }
    unlockedFromSubmit = null;
  };

  btnReload.onclick = () => loadState();

  btnShowCard.onclick = () => {
    if (!lastCard) return;
    const img = lastCard.cardPhotoUrl || lastCard.popPhotoUrl || null;
    showModal({
      title: "üíå –û—Ç–∫—Ä—ã—Ç–∫–∞ –∑–∞ —à–∞–≥ " + lastCard.step,
      text: lastCard.cardText || "",
      imgUrl: img
    });
  };

  function renderDots(total, current) {
    progress.innerHTML = "";
    for (let i = 1; i <= total; i++) {
      const d = document.createElement("div");
      d.className = "dot";
      if (i <= current) d.classList.add("done");
      if (i === current + 1 && current < total) d.classList.add("current");
      if (current >= total) d.classList.add("done");
      progress.appendChild(d);
    }
  }

  async function apiGet(url, opts={}) {
    const res = await fetch(url, opts);
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return await res.json();
    const txt = await res.text();
    return { ok:false, error: txt };
  }

  async function loadState() {
    setToast("");
    hint.style.display = "none";
    miniActions.style.display = "none";
    finalBox.style.display = "none";
    btn.disabled = true;
    chip.textContent = "‚è≥ –ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";

    const url = STATE_URL + "?tma=" + encodeURIComponent(initData);
    const st = await apiGet(url);
    if (!st.ok) {
      chip.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞";
      setToast(st.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ.");
      btn.disabled = true;
      return;
    }

    renderDots(st.totalSteps || 5, st.currentStep || 0);

    lastCard = st.lastCard || null;

    if (st.isFinished) {
      taskTitle.textContent = "–ì–æ—Ç–æ–≤–æ ‚úÖ";
      taskText.textContent = "–¢—ã –ø—Ä–æ—à–ª–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è!";
      inputRow.style.display = "none";
      miniActions.style.display = lastCard ? "flex" : "none";
      finalBox.style.display = "block";
      finalText.textContent = st.finalText || "";
      chip.textContent = "üéÅ –§–∏–Ω–∞–ª";
      return;
    }

    inputRow.style.display = "grid";
    const cur = (st.task && st.task.step) ? st.task.step : ((st.currentStep || 0) + 1);
    taskTitle.textContent = "–ó–∞–¥–∞–Ω–∏–µ " + cur + " –∏–∑ " + (st.totalSteps || 5);
    taskText.textContent = (st.task && st.task.taskText) ? st.task.taskText : "‚Ä¶";
    btn.disabled = false;

    miniActions.style.display = lastCard ? "flex" : "none";
    chip.textContent = "–®–∞–≥ " + (st.currentStep || 0) + "/" + (st.totalSteps || 5);

    // Show hint from previous step if any (soft)
    if (st.lastHint) {
      hint.style.display = "block";
      hint.textContent = "‚ú® –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞: \n" + st.lastHint;
    }

    el("small").textContent = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–≤–µ—Ç—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —Ç–æ—á–Ω–æ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤/—Ä–µ–≥–∏—Å—Ç—Ä–∞).";
  }

  async function submitAnswer() {
    const a = (answer.value || "").trim();
    if (!a) {
      setToast("–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç üôÇ");
      answer.classList.add("shake");
      setTimeout(()=>answer.classList.remove("shake"), 250);
      return;
    }
    btn.disabled = true;
    setToast("–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶");

    const url = SUBMIT_URL + "?tma=" + encodeURIComponent(initData);
    const resp = await apiGet(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answer: a })
    });

    btn.disabled = false;

    if (!resp.ok) {
      setToast(resp.error || "–û—à–∏–±–∫–∞.");
      return;
    }

    if (!resp.correct) {
      setToast(resp.message || "–ù–µ —Å–æ–≤–ø–∞–ª–æ üòÖ");
      el("mainCard").classList.add("shake");
      setTimeout(()=>el("mainCard").classList.remove("shake"), 280);
      return;
    }

    answer.value = "";
    unlockedFromSubmit = resp.unlocked || null;

    // show unlocked postcard
    if (unlockedFromSubmit) {
      const img = unlockedFromSubmit.cardPhotoUrl || unlockedFromSubmit.popPhotoUrl || null;
      showModal({
        title: "üíå –û—Ç–∫—Ä—ã—Ç–∫–∞",
        text: unlockedFromSubmit.cardText || "‚ú®",
        imgUrl: img
      });
    }

    // refresh state (next task / finish)
    await loadState();
  }

  btn.onclick = submitAnswer;
  answer.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitAnswer();
  });

  // Telegram init
  (function initTelegram() {
    try {
      if (!window.Telegram || !Telegram.WebApp) {
        chip.textContent = "‚ö†Ô∏è –û—Ç–∫—Ä–æ–π –≤ Telegram";
        taskTitle.textContent = "–ù—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ Telegram";
        taskText.textContent = "–ó–∞–ø—É—Å—Ç–∏ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞ –≤ Telegram üôÇ";
        inputRow.style.display = "none";
        return;
      }
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      initData = Telegram.WebApp.initData || "";
      if (!initData) {
        chip.textContent = "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        setToast("initData –ø—É—Å—Ç–∞—è. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏–∞–ø–ø –∏–∑ –±–æ—Ç–∞ –≤ Telegram.");
        inputRow.style.display = "none";
        return;
      }
      // optional: set main button off
      if (Telegram.WebApp.MainButton) Telegram.WebApp.MainButton.hide();
      loadState();
    } catch (e) {
      chip.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞";
      setToast(String(e));
    }
  })();

  // === Snow canvas (simple) ===
  (function snow() {
    const c = document.getElementById("snow");
    const ctx = c.getContext("2d");
    let w = 0, h = 0, dpr = 1;
    function resize() {
      dpr = Math.max(1, window.devicePixelRatio || 1);
      w = c.clientWidth = window.innerWidth;
      h = c.clientHeight = window.innerHeight;
      c.width = Math.floor(w * dpr);
      c.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    const N = 90;
    const flakes = Array.from({length:N}, () => ({
      x: Math.random()*w,
      y: Math.random()*h,
      r: 0.8 + Math.random()*2.2,
      s: 0.4 + Math.random()*1.1,
      a: 0.15 + Math.random()*0.35,
      dx: -0.35 + Math.random()*0.7
    }));

    function tick() {
      ctx.clearRect(0,0,w,h);
      for (const f of flakes) {
        f.y += f.s;
        f.x += f.dx;
        if (f.y > h + 10) { f.y = -10; f.x = Math.random()*w; }
        if (f.x < -10) f.x = w + 10;
        if (f.x > w + 10) f.x = -10;

        ctx.beginPath();
        ctx.globalAlpha = f.a;
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  })();
</script>
</body>
</html>
